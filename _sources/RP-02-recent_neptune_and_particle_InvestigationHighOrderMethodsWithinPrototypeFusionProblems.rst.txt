RP-02-recent_neptune_and_particle_InvestigationHighOrderMethodsWithinPrototypeFusionProblems
============================================================================================

.. meta::
   :description: technical note

   :keywords: Progress,during,NEPTUNE,&,potential,interactions,with,particle,codes,David,Moxey,Department,of,Engineering,,King's,College,London,UKAEA,Nektar++,Training,Event,,1st,August,2022,Overview,‚Ä¢,As,part,of,NEPTUNE,,we,have,been,investigating,the,application,of,high-,order,methods,within,prototype,fusion,problems.,‚Ä¢,The,work,undertaken,thus,far,focuses,on,three,areas:,High-order,mesh,generation,Performance,on,modern,hardware,Community,engagement,with,NEPTUNE,‚Ä¢,How,do,we,generate,meshes,suitable,for,fusion,applications?,‚Ä¢,High-order,methods,show,great,potential,for,exascale,platforms.,‚Ä¢,NEPTUNE,is,composed,of,several,partners,,each,developing,proxyapps,‚Ä¢,Consider,surface,mesh,accuracy,,anisotropy,and,geometric,complexity.,‚Ä¢,Examining,how,performant,kernels,can,be,designed,for,unstructured,elements.,‚Ä¢,Developing,coupling,approaches,,modern,CI,and,coordination,CAD-exact,feature,representation,‚Ä¢,For,fusion,applications,,certain,internal,features,such,as,the,plasma,separatrix,should,be,modelled,as,accurately,as,possible.,‚Ä¢,Also,beneficial,to,generate,anisotropic,elements,within,these,regions,to,align,with,the,corresponding,physical,models.,‚Ä¢,Within,the,mesh,generation,process,,we,therefore,consider,the,use,of,internal,CAD,curves,which,allow,for,exact,representation,of,these,features.,‚Ä¢,Furthermore,,the,optimisation,process,can,be,made,CAD-aware,,so,that,during,optimisation,,nodes,'slide',along,CAD,curves,&,surfaces.,‚Ä¢,Implementation,of,this,within,the,high-order,mesh,generation,software,NekMesh,,which,is,part,of,the,Nektar++,spectral/hp,element,framework.,Example:,circle,in,square,Using,the,modiÔ¨Åed,NekMesh,with,the,CAD,curve,reÔ¨Ånement,and,executing,the,same,command,as,the,previous,case,with,the,unmodiÔ¨Åed,code,,we,can,see,in,Figure,5(b),that,the,resolution,around,the,circle,drastically,increases.,Additionally,,the,octree,smoothing,is,exerting,its,in-,Ô¨Çuence,throughout,most,of,the,domain,,which,further,increase,the,resolution,,resulting,with,a,mesh,containing,4,184,elements,and,66,022,degrees,of,freedom.,Mesh,edges,align,with,CAD,curve,regions,Figure,3:,Illustration,of,the,faces,and,edges,of,the,circle,in,square,test,case.,CAD,boundary,representation,Coarse,high-order,grid,(a),Isotropically-refined,high-order,(b),grid,Figure,5:,Mesh,of,the,circle,in,square,test,case,(a),the,unmodiÔ¨Åed,version,of,NekMesh,with,no,reÔ¨Ånement;,(b),the,modiÔ¨Åed,version,of,NekMesh,using,reÔ¨Ånement,around,the,CAD,curves,of,the,circle.,5.1.3,r-adaptation,Despite,the,increase,in,resolution,,the,mesh,produced,by,employing,reÔ¨Ånement,is,still,isotropic,and,there,is,no,clustering,within,the,reÔ¨Åned,zone,around,the,circle‚Äôs,curves.,To,achieve,that,,we,employed,the,r-adaptation,method,,which,shall,be,explored,next.,Keeping,in,mind,Section,4.3,,the,pipeline,process,where,multiple,executions,of,the,variational,optimisation,module,using,di‚Üµerent,parameters,will,be,demonstrated,with,the,steps,discussed,hereafter.,(a),First,,we,attempt,to,generate,a,mesh,using,r-adaptation,only,on,elements,adjacent,to,the,(b),circle‚Äôs,curve,,i.e.,without,specifying,a,radius.,This,is,done,with,following,command:,Figure,4:,Illustration,of,the,separate,faces,and,associated,edges,of,the,circle,in,square,test,case,showing,(a),the,square,region,without,the,embedded,circle;,(b),the,circle,region,without,the,surrounding,square.,NekMesh,-v,NekMesh,-v,-m,varopti:hyperelastic:nq=5,2d_circle_square.mcf,!,2d_circle_square.xml,,,!,,,stol=1e-5:nq=2:numthreads=10,-m,varopti:hyperelastic:nq=5:numthreads=10,2d_circle_square.mcf,2d_circle_square.xml,-m,varopti:linearelastic:radaptcurves=1-4:radaptscale=0.275:subiter=5:re,c,<NEKTAR>,<MESHING>,We,note,the,use,of,additional,options,,namely,restol,and,numthreads,which,were,not,pre-,viously,explained.,The,former,is,the,minimum,residual,required,to,halt,the,iterations,in,the,variational,optimisation,process,,and,the,latter,is,number,of,execution,threads,on,a,muti-,12,threaded,CPU.,As,explained,in,Section,3.2,,the,r-adaptation,is,executed,on,a,linear,mesh,by,using,nq=2,,followed,by,a,second,pass,of,the,variational,optimisation,module,without,r-,adaptation,and,using,nq=5,to,promote,the,mesh,to,4th,order,whilst,ensuring,the,process,of,increasing,the,polynomial,order,doesn‚Äôt,degrade,the,mesh,quality.,14,Example:,circle,in,square,Applying,anisotropic,refinement,Close-up,view,of,boundary,of,circle,Interior,layer,refinements,‚Ä¢,Have,also,begin,process,of,generating,refinement,in,a,more,structured,manner.,‚Ä¢,This,uses,boundary,layer,refinement,strategies,we,typically,adopt,for,external,flows,but,on,the,internal,CAD,curve.,‚Ä¢,Isoparametric,approach,allows,arbitrary,refinement,as,desired.,Example:,sample,plasma,core,separatrix,‚Ä¢,Same,process,applied,to,a,schematic,tokamak,cross-section.,‚Ä¢,Fully,valid,mesh,(no,inverted,elements),at,order,P,=,5,.,‚Ä¢,Potential,future,directions:,‚Ä£,extension,to,3D;,‚Ä£,improving,performance,via,different,optimisation,strategies;,‚Ä£,distributed-type,parallelism,,GPU,offloading.,Performance,&,matrix-free,operator,evaluation,‚Ä¢,A,key,ability,of,high-order,methods,is,their,arithmetic,intensity:,the,ratio,of,floating-point,operations,(FLOPS),per,byte,of,data,transferred,over,memory.,‚Ä¢,As,P,increases,,so,too,does,the,amount,of,FLOPS,needed,for,evaluation.,‚Ä£,This,sounds,bad,,but,we,get,a,corresponding,increase,in,accuracy!,‚Ä¢,Significantly,reduce,the,impact,of,memory,bandwidth,limits,found,on,modern,hardware,architectures,&,exascale,platforms.,‚Ä¢,Solution,of,the,anisotropic,heat,transport,involves,evaluation,of,operators,‚Ñí(u),=,‚àá[D,‚ãÖ,‚àáu],,,where,D,is,a,spatially-constant,d,√ó,d,tensor.,‚Ä¢,Second,track,of,work,focuses,on,performant-kernels,for,this,operator,,particularly,focused,on,unstructured,elements,due,to,complexity,of,geometry,found,in,realistic,problems.,4.3.2,3-D,elements,Pyramidal,A,similar,approach,to,the,2-D,elements,test,cases,was,taken,in,terms,of,generating,the,mesh,The,hardware,that,was,used,to,run,both,conÔ¨Åg-,geometry,for,the,3-D,element,test,cases.,How-,urations,was,a,compute,node,with,24,hardware,ever,,the,3-D,meshes,had,signiÔ¨Åcantly,less,el-,cores,,192GB,RAM,and,two,Intel,Xeon,Phi,7120,For,the,pyramidal,mesh,,there,were,6,elements,arranged,in,a,cuboid,volume.,The,mesh,can,be,seen,in,Figures,4.20,and,4.21.,The,solution,superimposed,onto,this,grid,can,be,seen,in,Fig-,ements,,as,the,focus,was,to,run,quick,tests,in,ure,4.22.,processors.,Tetrahedral,For,the,tetrahedral,mesh,,there,were,6,elements,arranged,in,a,cuboid,volume.,The,mesh,can,be,seen,in,Figure,4.23.,The,solution,superimposed,onto,this,grid,can,be,seen,in,Figure,4.24.,Timings,were,then,taken,for,the,four,test,cases,,with,polynomial,order,set,to,3,P,√Ü,√Ü,7.,The,timings,taken,for,the,quadrilateral,,prismatic,,pyramidal,and,tetrahedral,test,cases,can,be,seen,in,Figures,4.12,,4.13,,4.14,and,4.15,respec-,(4.4),order,to,aid,code,iteration,during,the,design,process.,Also,,each,test,case,was,only,run,25,4.3.1,2-D,elements,times,before,the,mean,was,taken.,For,testing,2-D,elements,,quadrilateral,and,tri-,angle,mesh,geometries,were,generated,in,Gmsh.,A,high,number,of,elements,in,each,mesh,was,de-,Hexahedral,sired,in,these,test,cases,,in,order,to,prevent,any,For,the,hexahedral,mesh,,there,were,6,elements,cases,of,data,being,stored,during,execution,,in-,arranged,in,a,cuboid,volume.,The,mesh,can,be,stead,of,computation,over,every,element.,Each,seen,in,Figure,4.16.,The,solution,superimposed,test,case,was,run,1000,times,,and,the,mean,was,onto,this,grid,can,be,seen,in,Figure,4.17.,taken.,Prismatic,c,4,Quadrilateral,3,3,3,c,4,For,the,prismatic,mesh,,there,were,54,elements,For,the,quadrilateral,mesh,,there,were,1972,ele-,Ô¨Åz,arranged,in,a,cuboid,volume.,The,mesh,can,be,ments,arranged,in,a,hexagonal,shape.,The,mesh,seen,in,Figure,4.18.,The,solution,superimposed,can,be,seen,in,Figures,4.5,,4.6,and,4.7.,The,so-,onto,this,grid,can,be,seen,in,Figure,4.19.,lution,superimposed,onto,this,grid,can,be,seen,c,4,(4.5),tively.,in,Figure,4.8.,Triangular,For,the,triangular,mesh,,there,were,4096,ele-,ments,arranged,in,a,hexagonal,shape.,The,mesh,can,be,seen,in,Figures,4.9,and,4.10.,The,solu-,tion,superimposed,onto,this,grid,can,be,seen,in,Figure,4.11.,Timings,were,then,taken,for,both,of,these,test,For,the,3-D,cases,,the,forcing,function,and,boundary,conditions,used,were,similar:,uboundary,=,sin,Ô¨Åx,Ô¨Åy,sin,sin,a,4,3,b,4,3,c,4,3,Ô¨Åz,where,a,,b,,c,were,set,to,arbitrary,constants,,and,f,=,‚ÅÑ,+,Ô¨Å2,‚â†,5,‚Ä°00,a2,+,‚Ä°11,b2,+,‚Ä°22,c2,3,Ô¨Åx,sin,3,‚Ä°01,3,3,ab,4,‚Ä°02,ac,4,‚Ä°12,bc,4,3,a,4,cos,cos,sin,sin,3,Ô¨Åx,3,a,4,Ô¨Åx,3,a,4,Ô¨Åx,a,4,3,Ô¨Åy,46,Ô¨Åz,sin,b,4,cos,3,Ô¨Åy,c,4,sin,3,b,4,Ô¨Åy,3,b,4,Ô¨Åy,b,4,3,cos,cos,sin,cos,+,2Ô¨Å2,+,2Ô¨Å2,+,2Ô¨Å2,Ô¨Åz,Ô¨Åz,The,exact,analytical,solution,,to,be,used,to,compare,to,the,numerical,solution,found,,was:,u,=,sin,Ô¨Åx,Ô¨Åy,sin,sin,a,4,3,b,4,3,c,4,3,Ô¨Åz,(4.6),The,test,Ô¨Åles,were,run,in,two,conÔ¨Ågurations,,with,and,without,the,Ô¨Çags,for,SIMD,vectori-,sation,on,during,compilation,in,cmake.,These,Ô¨Çags,were:,‚Ä¢,NEKTAR,ENABLE,SIMD,AVX2,set,to,ON.,‚Ä¢,CMAKE,CXX,FLAGS,set,to,-mavx2,-mfma.,Software,implementation,cases,,with,polynomial,order,set,to,3,√Ü,7.,The,timings,taken,for,the,quadrilateral,test,case,can,be,seen,in,Figure,4.3,,and,the,timings,taken,for,the,triangular,test,case,can,be,seen,in,Figure,4.4.,√Ü,P,Figure,4.12:,Timings,for,hexahedral,mesh.,Figure,4.13:,Timings,for,prismatic,mesh.,‚Ñí(u),=,‚àá[D,‚ãÖ,‚àáu],d,x,d,spatially-constant,diffusion,tensor,Figure,4.3:,Timings,for,quadrilateral,mesh.,Figure,4.4:,Timings,for,triangular,mesh.,Figure,4.14:,Timings,for,pyramidal,mesh.,Figure,4.15:,Timings,for,tetrahedral,mesh.,22,Good,speedups,observed,over,non-vectorised,versions,of,26,this,operator,for,both,2D,&,3D,elements,Test,cases,within,NEPTUNE,‚Ä¢,Focuses,around,setup,of,a,solver,for,a,highly,anisotropic,heat,transport,case,based,on,high-order,elements.,3,2,N,‚àÇT,‚àÇt,=,‚àá,‚ãÖ,(Œ∫‚à•b[b,‚ãÖ,‚àáT],+,Œ∫‚ä•(,‚àáT,‚àí,[b,‚ãÖ,‚àáT])),‚Ä¢,Two,aspects,being,considered:,‚Ä¢,Physics:,for,this,model,problem,,how,do,high-,order,elements,perform,for,high,levels,of,anisotropy?,‚Ä¢,Software:,how,do,we,implement,efficient,realisations,suitable,for,exascale,platforms?,Figure,1:,Sketch,of,the,test,conÔ¨Åguration,,showing,Ô¨Åeldlines,in,direction,b,and,the,boundary,between,anisotropic,conductor,and,perfect,insulator.,black,line,which,denotes,the,boundary,between,anisotropic,conductor,and,perfect,insulator.,The,exact,steady-state,solution,has,T,=,constant,along,Ô¨Åeldlines,,but,numerical,diffusion,will,result,in,non-zero,T,in,the,region,of,blue,Ô¨Åeldlines.,The,relative,size,of,this,numerical,diffusion,must,be,estimated,as,a,function,of,incidence,angle,‚úì,,where,interest,attaches,to,small,‚úì,2o.,Ô£ø,To,test,curvature,effects,the,whole,2-D,domain,of,Figure,1,could,be,distorted,by,conformal,map-,ping,(which,preserves,angles).,3.1.2,Intermediate,Case,3.1.3,Realistic,Case,This,needs,to,be,3-D,and,involve,JET,divertor,tile,descriptions,derived,from,the,output,of,the,CAD,design,tool,,together,with,information,describing,the,magnetic,Ô¨Åeld,as,a,function,of,position,,which,will,be,supplied.,The,magnetic,equilibrium,may,be,supplied,analytically,after,Solovev,,but,the,usual,input,is,as,an,.eqdsk,Ô¨Åle.,The,EQDSK,G,format,is,a,‚Äúnon-standard‚Äù,standard,for,solutions,(R,,Z),,p(,),,F,(,),of,the,Grad-Shafranov,equation,,where,is,the,magnetic,Ô¨Çux,and,(R,,Z),are,cylindrical,coordinates,in,planes,normal,to,the,toroidal,direction.,The,functions,p,and,F,give,the,variation,of,the,pressure,and,toroidal,Ô¨Åeld,respectively.,The,basic,standard,for,EQDSK,G,may,be,found,at:,https://fusion.gat.com/theory/Efitgeqdsk,(which,may,be,password-protected),or,else,at,https://w3.pppl.gov/ntcc/TORAY/G_EQDSK.pdf,The,Ô¨Çux,(R,,Z),is,sampled,at,uni-,formly,spaced,points,on,a,direct,product,grid,,for,which,the,.eqdsk,header,deÔ¨Ånes,the,mesh-size,,as,well,as,other,useful,information,,such,as,the,Ô¨Çux,on,axis,and,at,boundary.,Unfortunately,the,strict,EQDSK,G,standard,uses,a,Fortran,format,that,does,not,require,spaces,between,samples,,9,Development,of,proxyapps,Steady,State,Case,Anisotropic,heat,transport,P=8,https://github.com/ExCALIBUR-NEPTUNE/nektar-diffusion,SOL-solver,(single,species,1D,solver),3,https://github.com/ExCALIBUR-NEPTUNE/nektar-sol-1d,Hasegawa-Wakatani,drift-wave,system,https://github.com/ExCALIBUR-,NEPTUNE/nektar-driftwave,Particle,interactions,System,2-6,progress,‚Ä¢,(From,my,perspective!),a,somewhat,scary,set,of,equations,for,a,2D,fluid,model.,‚Ä¢,Thanks,to,Ed/James,for,a,fully,laid,out,version,of,this!,‚Ä¢,To,date,progress,mostly,around,scoping:,what,do,we,have,,and,what,do,we,not,have.,‚Ä¢,One,thing,that,will,need,to,be,addressed,is,interaction,with,particle,codes.,‚Ä¢,Will,briefly,outline,how,this,could,work,with,Nektar++.,Particles,in,Nektar++,to,date,‚Ä¢,Some,attempts,have,been,made,in,the,past,to,introduce,simple,to,moderately,complex,Lagrangian,particle,tracing,within,Nektar++.,‚Ä¢,These,were,particularly,motivated,by,physical,fluid,dynamics,applications,(e.g.,erosive,wear.),‚Ä¢,There,are,essentially,three,interactions,required:,‚Ä£,for,a,given,particle,location,in,world-space,,which,element,does,this,correspond,to,in,the,grid,(and,in,parallel,execution),,and,what,are,the,reference,coordinates,within,that,element;,‚Ä£,given,that,location,,evaluate,the,solution,field(s),there,to,e.g.,extract,velocity;,‚Ä£,given,results,of,the,particle,code,,project,e.g.,density,into,the,finite,element,space.,Finding,positions,‚Ä¢,This,can,be,done,at,two,levels,within,the,library,hierarchy:,‚Ä£,Within,SpatialDomains,,each,Geometry,object,has,a,ContainsPoint,method,,which,accepts,as,parameter,a,position,in,world-space.,(x,,y,,z),‚Ä£,Within,MultiRegions,,an,ExpList,object,has,a,GetExpIndex,method,which,performs,essentially,the,same,action,,but,has,a,couple,of,additional,speed-ups,and,is,also,designed,to,handle,e.g.,manifolds.,‚Ä¢,Finding,positions,‚Ä¢,In,particular,we,use,the,following,process,to,speed,up,location,searches,within,the,mesh:,‚Ä£,At,mesh,construction,time,,for,each,element,of,the,mesh,,construct,the,element's,bounding,box.,‚Ä£,We,then,use,the,bounding,boxes,to,construct,an,r-tree.,‚Ä£,When,we,look,up,a,point,,we,first,use,the,r-tree,to,locate,the,subset,of,elements,that,might,contain,this,point.,‚Ä£,Then,,we,loop,over,those,subset,and,call,the,ContainsPoint,method.,‚Ä¢,However,the,last,point,can,still,be,expensive,if,we,are,querying,curvilinear,elements.,Finding,reference,locations,‚Ä¢,Since,we,ultimately,want,to,evaluate,at,points,within,the,element,,we,need,to,know,the,location,within,the,reference,element.,‚Ä¢,To,do,this,requires,inverting,the,mapping,œá,that,is,used,to,define,the,element.,‚Ä¢,For,straight,sided,elements,,is,affine,and,œá,this,is,straightforward;,however,for,curvilinear,elements,(or,non-parallelepiped,quads/hexes),this,is,non-linear.,‚Ä¢,We,solve,via,a,Newton-Raphson,search.,Finding,minimum,distance,between,a,point,and,an,element's,edge,Bounding,boxes,for,curvilinear,elements,‚Ä¢,Additional,headache,is,bounding,boxes,are,also,difficult/expensive,to,compute.,‚Ä¢,Cheap,guess,is,to,use,quadrature,points,and,add,a,small,margin,(e.g.,10%).,Experimental,branch,where,we,compute,exact,boxes,at,additional,costs.,Barycentric,formulation,for,Lagrangian,interpolation,‚Ä¢,Given,an,element,,a,location,within,the,reference,element,,and,a,field,represented,at,the,quadrature,points,,we,can,evaluate,the,field,at,that,point.,‚Ä¢,This,is,a,straightforward,polynomial,interpolation,,which,can,be,performed,by,calling,the,StdRegions,function,PhysEvaluate,call.,‚Ä¢,Until,relatively,recently,,this,was,quite,expensive,at,for,a,1D,segment.,However,we,can,leverage,ùí™(P2),tricks,from,spectral,methods,to,reduce,this,via,barycentric,interpolation.,‚Ä¢,Storing,weights,allows,us,to,perform,polynomial,wj,interpolation,at,any,location,in,derivatives).,ùí™(P),time,(and,Results,-,optimisation,profiling,‚Ä¢,Example,in,the,FindDistance,function,shown,before,for,138,points,along,a,curved,interface.,‚Ä¢,Benchmarking,existing,Lagragian,interpolation,method,with,old/new,bounding,boxes,vs.,new,barycentric,formulation.,‚Ä¢,Significant,speedup,for,this,problem,(nonconformal,DG,grid).,FindDistance,[%CPU],Total,computation,time,[s],L2,Error,91.12%,43.2631s,4.73493E-10,85.15%,30.7281s,4.73493E-10,24.47%,4.86649s,4.73493E-10,Lagrangian,(old,bbox),Lagrangian,(new,bbox),Barycentric,(new,bbox),Other,considerations,‚Ä¢,At,present,,these,routines,are,not,parallel,aware,so,all,local,domains,on,each,rank,handle,things,independently.,‚Ä¢,Need,to,investigate,mesh,halos,(from,Will's,code),and,use,of,appropriate,logic,to,handle,fringe,cases,(e.g.,landing,exactly,on,vertex,of,element,shared,across,parallel,partitions).,‚Ä¢,Interactions,with,boundaries,can,also,be,difficult,to,handle,where,the,boundary,is,curved:,similar,issues,with,solving,nonlinear,problems,and,can,be,easy,to,miscompute,e.g.,deflection,angles,when,looking,at,particle-boundary,collisions.

:pdfembed:`src:_static/RP-02-recent_neptune_and_particle_InvestigationHighOrderMethodsWithinPrototypeFusionProblems.pdf, height:1600, width:1100, align:middle`

