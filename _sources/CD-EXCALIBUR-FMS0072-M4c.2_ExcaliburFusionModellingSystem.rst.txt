CD-EXCALIBUR-FMS0072-M4c.2_ExcaliburFusionModellingSystem
=========================================================

.. meta::
   :description: technical note

   :keywords: ExCALIBUR,2-D,integrated,particle,and,continuum,model,M4c.2,Version,1.00,Abstract,The,report,describes,work,for,ExCALIBUR,project,NEPTUNE,at,Mile-,stone,M4c.2.,An,integrated,particle,and,continuum,model,has,been,de-,veloped,in,2d3v,,where,2d3v,implies,that,there,is,variation,in,two,space,dimensions,(2-D),and,3,velocity-phase,space,coordinates.,NEKTAR++,pro-,vides,the,2-D,ﬁnite,elements,to,represent,the,plasma,as,a,ﬂuid,,whereas,3-D,velocity-phase,space,is,populated,with,particles,to,represent,the,neu-,tral,particles,and,the,complete,calculation,is,orchestrated,by,the,NESO-,PARTICLES,software,developed,under,project,NEPTUNE.,Much,of,the,new,code,uses,SYCL,to,pave,the,way,to,Exascale,in,a,performance-portable,manner.,Initial,tests,using,a,small,range,of,boundary,conditions,and,sources,demonstrate,successful,strong,coupling,between,the,ﬂuid,and,the,new,par-,ticle,code.,Additionally,,summaries,are,provided,of,work,by,a,grantee,to,develop,a,high-dimensional,ﬁnite,element,library,intended,to,provide,a,com-,plementary,approach,to,the,use,of,particles.,UKAEA,REFERENCE,AND,APPROVAL,SHEET,Client,Reference:,UKAEA,Reference:,CD/EXCALIBUR-FMS/0072,Issue:,Date:,1.00,March,21,,2023,Project,Name:,ExCALIBUR,Fusion,Modelling,System,Prepared,By:,Name,and,Department,James,Cook,Will,Saunders,Owen,Parry,Signature,N/A,N/A,N/A,Date,March,21,,2023,March,21,,2023,March,21,,2023,BD,Reviewed,By:,Wayne,Arter,March,21,,2023,Project,Technical,Lead,1,1,Introduction,The,reach,of,this,milestone,is,to,create,a,proxyapp,that,combines,at,least,one,complex,element,from,several,aspects,of,exhaust,physics.,This,2d3v,proxyapp,is,based,on,an,advection-diffusion-,reaction,(ADR),equation,system,where,the,source,terms,arise,from,the,ionisation,of,neutral,parti-,cles,which,are,treated,as,Lagrangian,markers.,The,system,of,three,coupled,ﬂuid,equations,for,number,density,,velocity,and,energy,,encapsulated,in,a,state,vector,(cid:126)ς,and,expressed,in,a,form,familiar,to,the,area,of,CFD,and,speciﬁcally,Finite,Volume,formulations,as,∂(cid:126)ς,∂t,+,∇,·,(F((cid:126)ς)),=,G((cid:126)ς,,∇,·,(cid:126)ς),+,S((cid:126)ς),,∇,(1),where,F,represents,the,spatial,component,of,a,general,hyperbolic,conservation,law,,G,denotes,the,diffusion,terms,and,S((cid:126)ς),is,the,source,term,for,the,components,of,the,state,vector.,We,provide,the,particular,system,of,equations,of,interest,in,Section,2.1.1.,In,this,report,we,present,details,of,the,implementation,and,present,initial,results,of,an,exhaust,relevant,ADR,solver,constructed,from,NEKTAR++,and,NESO-PARTICLES(NP),and,realised,as,part,of,the,NESO,framework.,The,targeted,real-world,scenario,is,the,scrape-off-layer,(SOL),which,connects,the,tokamak,divertor,(heat,sink),to,the,bulk,plasma,at,the,outer,mid-plane,edge,(heat,source).,Furthermore,the,plasma,is,coupled,to,a,system,of,neutral,particles.,The,ﬂuid,species,exists,as,a,ﬁnite,element,representation,provided,by,the,NEKTAR++,library.,The,neutral,particle,species,is,implemented,using,the,NP,framework.,Within,NESO,there,exists,a,tight,coupling,between,ﬁnite,element,functions,within,NEKTAR++,and,particles,in,NP.,The,computationally,challenging,dynamics,are,largely,aligned,to,the,magnetic,ﬁeld,,which,pred-,icates,the,use,of,a,long,,thin,computational,domain,also,aligned,with,the,magnetic,ﬁeld.,In,this,domain,,the,plasma,source,is,located,in,the,middle,and,the,upper,and,lower,divertors,are,located,at,the,ends.,This,proxyapp,implements,a,system,with,an,element,of,complexity,from,many,areas,of,the,parameter,space:,advection-diffusion,in,NEKTAR++,,performance,portable,particles,via,NP,,domain,decomposition,via,MPI,,mixed,boundary,conditions,,tight,coupling,of,ﬂuids,and,particles,,IO,,visualisation,,and,crucially,2,spatial,dimensions,and,3,velocity,dimensions.,The,ﬁnal,element,of,complexity,is,critical,for,providing,functionality,to,the,tokamak,edge,modelling,community,who,wish,to,calculate,the,heat,ﬂuxes,required,for,so-called,mean,ﬁeld,equations,in,2-D,with,neutral,physics,via,particles,with,all,three,velocity,components.,The,structure,of,the,rest,of,the,report,is,as,follows.,In,Section,2,we,describe,the,technical,work,done,for,this,report,and,describe,the,equations,that,are,solved,for,the,ﬂuid,dynamics,and,particles,,how,they,are,coupled,and,the,how,the,ionisation,rates,are,obtained.,We,also,present,an,exposition,of,the,ionisation,algorithm.,We,provide,a,description,of,the,basis,functions,in,NEKTAR++,and,their,efﬁcient,evaluation,in,NESO,via,SYCL.,In,Section,3,,we,summarise,and,give,context,to,two,associated,grantee,reports,on,this,topic.,The,ﬁnal,section,provides,a,summary,of,this,work.,2,2,Task,Work,2.1,Plasma,,particle,and,ionisation,equations,The,plasma,exhaust,is,modelled,in,2-D,in,a,long,and,thin,domain,,where,the,centre,represents,the,outer,mid-plane,edge,of,the,plasma,,ie.,broadly,where,the,hot,plasma,enters,the,scrape,off,layer,domain,,and,the,ends,represent,the,divertor,,ie.,the,plasma,from,the,centre,travels,along,the,domain,in,both,directions,towards,the,exhaust,region.,Critical,to,fusion,power,plant,design,is,the,concept,of,a,detached,plasma,whereby,a,region,of,ionisation,and,recombination,exists,between,the,plasma,and,the,divertor.,This,detached,state,is,beneﬁcial,as,the,divertor,is,in,contact,with,merely,a,hot,gas,rather,than,a,plasma,carrying,orders,of,magnitudes,larger,heat,ﬂuxes.,The,region,of,ionisation,and,heat,ﬂux,near,the,ends,of,this,long,and,thin,2-D,domain,is,represented,in,this,mini-app,as,locations,of,neutral,particle,sources,(whose,presence,in,a,real,tokamak,would,arise,via,gas,puffs,,recycling,from,the,wall,and,the,processes,of,ionisation,and,recombination,between,the,neutral,gas,and,the,detached,plasma).,In,this,instance,,we,focus,on,ionisation,only,and,leave,recombination,as,an,item,of,further,work.,The,following,sections,describe,the,ﬂuid,and,particle,dynamical,equations,and,the,origin,of,the,ionisation,rates.,2.1.1,Dynamics,equations,The,plasma,exhaust,relevant,ﬂuid,equations,,in,the,form,of,an,advection-diffusion-reaction,(ADR),equation,,are,expressed,in,2-D,by,Eulerian,methods,,where,the,source,terms,in,the,ﬂuid,equa-,tions,arise,from,the,ionisation,of,neutral,particles.,We,treat,these,neutral,particles,as,Lagrangian,markers.,We,describe,the,time,evolution,of,number,density,n,,velocity,(cid:126)u,and,double,energy,E,=,(g,2)nT,+,nu2,as,−,Ur,n,=,∂,∂t,∂,∂t,2)T,+,u2)),=,n(cid:126)u,=,Ur,(n(cid:126)u),+,Sn,,−∇,·,−∇,·,(n(cid:126)u,⊗,(cid:126)u,+,nT,(cid:126)I),+,Su,,(n(cid:126)u(gT,+,u2)),κd,∇,−,2T,+,SE,,−∇,·,(2),(3),(4),Ur,∂,∂t,(n((g,−,where,T,and,g,are,the,plasma,temperature,and,equation,of,state,constant,respectively,and,Si,is,the,source,term,for,variable,i,arising,from,the,ionisation,of,neutral,particles.,The,neutral,com-,putational,macroparticles,follow,straight,trajectories,from,birth,until,either,loss,due,to,complete,ionisation,or,because,they,have,travelled,past,the,ends,of,the,domain,in,the,long,direction,ie.,hit,the,divertor,target.,We,sample,initial,neutral,particle,properties,from,a,ﬁxed,density,and,temperature,proﬁle.,We,ad-,vect,each,neutral,particle,collisionlessly,,ie.,without,external,forces,or,inter-particle,interaction,,and,at,each,time,step,perform,an,ionisation,procedure.,This,ionisation,procedure,requires,evaluation,of,the,plasma,density,and,temperature,at,the,location,of,each,particle,to,calculate,an,ionisation,rate.,The,ionisation,rate,determines,the,proportion,of,the,weight,of,each,neutral,particle,which,will,be,deposited,onto,the,grid,as,plasma.,3,The,deposition,of,newly,ionised,plasma,takes,the,form,of,source,terms,in,the,plasma,density,,mo-,mentum,density,and,energy,density,equation.,For,conservation,of,mass,,momentum,and,energy,,the,source,terms,in,the,plasma,equations,must,be,commensurate,with,the,loss,of,neutral,density,,momentum,and,kinetic,energy,from,particles.,We,weakly,equate,particle,and,ﬁnite,element,repre-,sentations,of,a,quantity,via,a,L2,Galerkin,projection.,We,describe,the,ionisation,algorithm,below,and,describe,the,ionisation,rate,calculation,the,next,section.,for,particle,species,do,∈,position(particle),weight(particle),velocity(particle),density(x),temperature(x),rate(T,),x,←,w,←,u,←,n,←,T,←,r,←,∆w,remove,←,if,w,+,∆w,<,0,then,rnw∆t,0,←,−,∆w,remove,←,−,w,1,←,end,if,w,nS,uE,end,for,←,←,←,w,+,∆w,nS,uE,−,−,∆wu,∆wmu2/2,2.1.2,Ionisation,rates,We,use,the,following,formula,,taken,from,Ref.,[1],,as,the,ionisation,cross,section,σ,=,N,(cid:88),i=1,aiqi,(cid:17),ln,(cid:16),E,Ei,EEi,[1,−,(cid:16),E,Ei,(cid:17),−1,],−ci,bie,(5),where,E,is,the,energy,of,the,impacting,electron,,Ei,is,the,binding,energy,of,electrons,in,subshell,i,and,qi,is,the,number,of,electrons,in,the,i-th,subshell.,The,constants,ai,,bi,and,ci,are,to,be,determined,from,theory,or,experiment.,Note,that,for,hydrogen,and,Helium,like,ions,N,=,1.,In,the,following,table,we,list,the,reference,values,presented,in,[1],for,hydrogen,and,i,=,1.,Parameter,a1,b1,c1,E1,q1,Value,4x10−14cm2(eV,)2,0.6,0.56,13.6,eV,1,4,Figure,1:,Cross,section,plotted,against,electron,energy.,Figure,1,plots,this,approximation,for,the,cross,section,against,the,data,from,Freeman,and,Jones,[2].,We,use,the,cross,section,applied,to,a,Maxwellian,electron,distribution,at,temperature,T,to,generate,the,ionisation,rate,in,units,of,cm3/s,(see,Ref.,[1]),,S,=,6.7x107,N,(cid:88),i=1,aiqi,T,3,2,(cid:90),∞,Ei,T,e−x,x,dx,−,=,6.7x107,−,N,(cid:88),i=1,aiqi,T,3,2,T,Ei,(cid:16),Ei,(cid:17),Ei,T,−,−,(cid:40),T,Ei,(cid:40),bieci,Ei,T,+,ci,bieci,Ei,T,+,ci,(cid:90),∞,Ei,T,+ci,(cid:41),e−y,y,dy,(cid:41),(cid:17),(cid:16),Ei,Ei,T,−,ci,−,(6),where,T,is,in,eV.,Figure,2,compares,the,approximation,against,ADAS,provided,data.,We,assess,that,the,approximation,is,adequate,for,this,report.,Furthermore,we,use,the,closed,form,approxi-,mation,to,the,exponential,integral,by,Barry,et,al.,[3].,5,Figure,2:,Comparison,between,ADAS,data,and,approximation,plotted,against,electron,energy.,2.2,NEKTAR++,Although,NEKTAR++,includes,implementations,of,the,prerequisite,algorithms,required,by,NESO,to,project,particle,data,onto,ﬁnite,element,functions,and,evaluate,these,functions,at,particle,locations,these,methods,are,not,efﬁciently,implemented,for,the,particle,use,case.,The,original,implementa-,tions,in,NEKTAR++,are,adequately,implemented,for,use,in,the,setup,phase,of,a,simulation,where,small,inefﬁciencies,are,amortised,by,the,cost,of,the,time,stepping,loop,or,main,solve.,In,the,particle,use,case,,these,once,setup,only,functions,are,called,on,a,per-particle,basis,at,every,time,step,of,the,simulation.,This,per,particle,and,per,time,step,regime,places,these,functions,on,the,critical,path,of,the,simulation,where,small,inefﬁciencies,in,each,function,call,contribute,signiﬁcantly,to,the,overall,runtime.,Furthermore,the,implementations,of,these,methods,are,provided,only,on,the,CPU,host,hence,particle,data,,which,is,stored,on,a,compute,device,such,as,a,GPU,,must,be,copied,to,and,from,the,host,to,call,these,functions.,To,improve,the,performance,and,portability,of,NESO,we,provide,SYCL,implementations,of,these,critical,algorithms.,2.2.1,Function,Evaluation,NEKTAR++,considers,two,representations,of,a,given,function.,The,ﬁrst,representation,in,the,func-,tion,values,at,the,quadrature,points,in,the,domain.,The,second,representation,is,the,classic,ﬁnite,element,degrees,of,freedom,(DOFs),αj,such,that,u((cid:126)x),=,(cid:88),j,αjψj((cid:126)ξ((cid:126)x)),6,(7),where,u,is,the,function,represented,by,the,αj,,ψj,is,the,jth,basis,function,and,(cid:126)ξ((cid:126)x),is,the,position,in,the,reference,cell,of,the,point,(cid:126)x.,Hence,evaluating,Equation,(7),at,a,point,(cid:126)x,requires,evaluating,all,the,individual,basis,functions,at,(cid:126)x.,We,note,that,in,the,case,where,a,function,u,is,evaluated,at,all,particle,locations,with,a,mesh,cell,there,are,two,properties,that,are,computationally,beneﬁcial,on,modern,architectures;,ﬁrstly,the,DOFs,αj,are,constant,and,identical,for,all,evaluations,in,the,cell,secondly,the,functional,form,of,the,basis,functions,is,identical,for,all,the,evaluations,within,the,cell.,The,ﬁrst,property,indicates,that,evaluating,a,function,at,all,points,within,a,cell,as,a,grouped,operation,should,improve,cache,reuse,and,hence,improve,the,arithmetic,intensity,of,the,implementation.,The,second,property,indicates,that,the,basis,function,evaluations,for,different,points,in,the,cell,can,occur,in,adjacent,lanes,in,vector,computing,architectures,such,as,GPUs,and,CPU,SIMD,units.,Until,now,we,have,indexed,basis,functions,and,DOFs,with,a,single,index,j,,in,practice,there,exists,at,least,n,basis,function,indices,for,an,n,dimensional,space,(in,NEKTAR++).,In,this,report,we,consider,2-D,space,where,the,computational,mesh,is,constructed,as,a,collection,of,quadrilateral,and,triangular,elements.,Functions,deﬁned,over,quadrilaterals,and,triangles,are,constructed,as,the,tensor,product,of,a,1-D,basis,function,in,the,ﬁrst,and,second,dimensions,of,the,reference,element.,For,these,two,element,types,there,are,two,1-D,basis,functions,deﬁned,in,NEKTAR++;,the,“modiﬁed,A”,and,“modiﬁed,B”,basis,which,we,label,as,ψa,p,(z),and,ψb,For,n,“modes”,(polynomial,degree,plus,one),the,modiﬁed,A,basis,ψa,p,q(z),respectively.,p,is,deﬁned,as,ψa,p,(z),=,,,,1,z),2,(1,−,1,2,(1,+,z),z),1,1,2,(1,−,if,p,=,0,if,p,=,1,,,,(8),2,(1,+,z)P,(1,1),p−2,(z),otherwise,for,all,p,such,that,0,of,order,p.,The,ψb,p),q,<,(n,n,,0,≤,≤,−,},p,<,n.,In,this,report,P,(α,β),p,p,q(z),basis,is,deﬁned,over,a,triangle,number,sized,iteration,set,(z),denotes,the,standard,(α,,β),Jacobi,polynomials,p,<,(p,,q),:,0,{,≤,and,is,deﬁned,as,ψb,p,q(z),=,,,,ψa,q,(z),(cid:0),1,2,(1,+,z)(cid:1)p,z),(cid:0),1,1,2,(1,−,2,(1,+,z)(cid:1)p,P,(2p−1,1),q−1,if,p,=,0,if,q,=,0,(z),otherwise.,,,,(9),A,scalar,valued,function,u,of,n,modes,deﬁned,over,a,quadrilateral,by,coefﬁcients,α,is,evaluated,at,a,point,(cid:126)x,as,the,double,sum,u((cid:126)x),=,n−1,(cid:88),n−1,(cid:88),i=0,j=0,αjn+iψa,i,((cid:126)ξ((cid:126)x)0)ψa,j,((cid:126)ξ((cid:126)x)1).,(10),≤,O,each,with,j,<,n,},(n2),complexity,by,using,the,recursion,relation,of,the,Jacobi,We,evaluate,Equation,(10),with,j,:,polynomials,to,compute,and,store,the,values,(n),complexity.,These,basis,function,evaluations,are,then,reduced,along,0,with,the,appropriate,coefﬁcient,α,to,construct,u((cid:126)x).,This,two,stage,approach,places,the,code,that,(n2),operation,contains,multiple,conditionals,into,the,to,consist,purely,of,a,double,loop,and,a,reduction.,We,exploit,the,local,memory,feature,of,SYCL,to,allocate,temporary,memory,for,the,basis,function,evaluations,in,each,dimension.,(n),basis,evaluation,stage,and,allows,the,j,((cid:126)ξ((cid:126)x)1),ψa,{,i,((cid:126)ξ((cid:126)x)0),ψa,{,i,<,n,i,:,0,and,O,O,O,≤,∀,∀,},7,The,evaluation,of,a,function,u,over,a,triangle,follows,the,same,structure,with,three,modiﬁcations;,the,modiﬁed,B,basis,is,applied,in,the,second,dimension,,a,correction,is,applied,for,the,second,mode,and,the,reference,coordinate,is,converted,into,a,collapsed,coordinate,prior,to,evaluation.,For,triangular,elements,modes,,and,hence,DOFs,,are,not,indexed,in,a,lexicographic,manner,but,are,arranged,such,that,mode(p,,q),=,q,+,(cid:88),,,(cid:88),,,.,1,0<i≤p,0≤j<(n−i),(11),Although,the,mode,indexing,appears,convoluted,,in,actual,code,this,results,in,an,indexing,that,increments,by,one,in,each,iteration,of,the,nested,double,loop.,The,function,is,readily,evaluated,as,u((cid:126)x),=,(n−1),(cid:88),(n−i−1),(cid:88),i=0,j=0,(cid:20),αmode(i,j),δ1,mode(i,j),+,(1,δ1,mode(i,j))ψa,i,((cid:126)η((cid:126)x)0),−,(cid:21),ψb,i,j((cid:126)η((cid:126)x)1).,(12),where,δa,b,is,the,Kronecker,delta.,The,middle,square,terms,involving,the,Kronecker,delta,enclosed,by,square,brackets,represents,the,correction,applied,internally,by,NEKTAR++,for,the,second,mode.,The,coordinate,η,refers,to,the,reference,coordinate,in,the,collapsed,coordinate,space,which,is,applied,to,triangles,in,NEKTAR++.,This,collapsed,mapping,is,deﬁned,from,the,reference,space,(cid:126)ξ((cid:126)x),to,the,collapsed,space,(cid:126)η((cid:126)ξ((cid:126)x)).,Note,that,in,Equation,(12),we,wrote,(cid:126)η((cid:126)x),instead,of,(cid:126)η((cid:126)ξ((cid:126)x)),for,brevity,of,notation.,The,mapping,to,collapsed,coordinates,is,given,by,(cid:34),(cid:126)η((cid:126)ξ),=,2(1,+,(cid:126)ξ0)/(1,(cid:126)ξ1,−,(cid:126)ξ1),−,(cid:35),1,(13),As,in,the,quadrilateral,case,we,create,local,arrays,for,the,evaluations,of,ψa,i,j((cid:126)η1).,These,basis,function,evaluations,are,then,multiplied,together,and,reduced,in,a,double,loop,along,with,the,DOFs.,i,((cid:126)η0),and,ψb,2.2.2,Barycentric,Interpolation,The,alternative,function,representation,in,NEKTAR++,is,the,function,values,at,the,quadrature,points,across,the,entire,mesh.,These,are,referred,to,as,the,“physical,values”,and,can,be,converted,to,or,computed,from,the,DOFs.,NEKTAR++,provides,methods,to,compute,derivatives,from,these,physical,values,and,represents,these,derivatives,again,as,quadrature,point,values,(as,opposed,to,DOFs).,As,converting,physical,values,to,DOFs,has,a,non-negligible,cost,it,is,beneﬁcial,for,NESO,to,also,provide,a,SYCL,implementation,that,evaluates,a,function,deﬁned,by,quadrature,point,values,at,each,particle,location.,Hence,we,provide,a,SYCL,implementation,to,evaluate,NEKTAR++,functions,via,the,Barycentric,interpolation,[4],approach.,Note,that,this,algorithm,also,(n2),computational,complexity,for,n,modes,in,2-D,but,unlike,the,basis,function,evaluation,exhibits,approach,the,critical,path,consists,of,(n2),divisions.,O,O,8,2.2.3,Projection,onto,Finite,Element,Functions,In,Section,1.3,of,report,M4c,[5],we,describe,the,method,we,apply,to,convert,a,particle,represen-,tation,of,a,ﬁeld,to,a,weakly,equivalent,ﬁnite,element,representation,via,an,L2,Galerkin,projection.,This,projection,approach,solves,a,linear,system,where,the,RHS,is,constructed,by,evaluating,each,basis,function,at,the,location,of,each,particle.,In,prior,versions,of,NESO,these,basis,function,evaluations,were,performed,on,the,CPU,host,and,not,in,a,SYCL,parallel,loop.,With,the,SYCL,implementation,of,the,basis,functions,described,in,Section,2.2.1,,NESO,now,contains,a,performance,portable,implementation,to,compute,the,RHS,of,Equation,(11),in,M4c,[5].,The,mass-matrix,solve,required,to,solve,this,linear,system,is,however,still,performed,on,the,CPU,host.,2.2.4,The,Simple-SOL,solver,The,SIMPLE-SOL,solver,was,developed,initially,as,a,NEPTUNE,proxyapp,in,its,own,right,[6],to,solve,System,2–3,from,the,equations,document,[7].,While,the,simple,SOL,problem,is,only,formulated,in,1-D,,it,can,be,treated,as,a,pseudo-2-D,problem,by,giving,the,‘ﬁeld,line’,a,ﬁnite,width.,This,approach,allows,the,ﬂuid-particle,coupling,framework,to,be,tested,on,a,2-D,domain,whilst,retaining,access,to,existing,,relatively,simple,1-D,analytical,solutions,for,validation.,In,the,following,sections,,we,use,the,terms,‘SOL,axis’,and,‘cross-SOL,axis’,as,shorthand,for,directions,parallel,to,the,long,and,short,sides,of,the,domain,respectively.,Ur,n,=,∂,∂t,∂,∂t,2)T,+,u2)),=,n(cid:126)u,=,Ur,(n(cid:126)u),+,Sn,,−∇,·,−∇,·,(n(cid:126)u,⊗,(cid:126)u,+,nT,(cid:126)I),+,Su,,(n(cid:126)u(gT,+,u2)),κd,∇,−,2T,+,SE,,−∇,·,(14),(15),(16),Ur,∂,∂t,(n((g,−,Starting,from,Equations,(14)–,(16),,we,set,Ur,=,1,and,choose,to,neglect,heat,conduction,(κd,=,0).,We,assume,that,the,equation,of,state,is,that,of,an,ideal,gas,with,isentropic,expansion,factor,γ,=,5/3,,which,equates,to,setting,g,=,2,in,Equations(15),and,(16).,In,the,Nektar,solver,framework,,the,addition,of,a,second,dimension,entails,adding,an,extra,mo-,mentum,density,ﬁeld,,nv,and,modifying,the,construction,of,the,ﬂux,vector,used,in,the,Riemann,solver,when,computing,the,advection,terms.,We,apply,a,Discontinuous,Galerkin,(DG),formulation,to,model,the,ﬁelds,and,ﬂuxes,between,el-,ements,are,calculated,using,a,Riemann,solver,(implementation,due,to,Toro,[8]).,We,use,basis,functions,constructed,from,a,modiﬁed,form,of,(5th,order),Legendre,polynomial,,described,by,Kar-,niadakis,and,Sherwin,[9].,The,ﬂuid,ﬁelds,are,evolved,using,an,explicit,,4th,order,,Runge,Kutta,time,stepping,scheme.,In,order,to,test,the,solver,with,non-zero,momentum,terms,in,both,dimensions,,we,rotate,the,domain,about,the,origin,by,an,angle,θ,,such,that,the,SOL,axis,is,no,longer,aligned,with,the,x-axis.,The,9,rotation,angle,is,set,as,a,Nektar,parameter,in,the,conﬁguration,ﬁle,and,is,used,to,rotate,the,ﬂuid,source,terms,such,that,they,vary,along,the,SOL,axis,,but,are,constant,in,the,cross-SOL,direction.,The,(Dirichlet),boundary,conditions,at,the,ends,of,the,ﬂux,tube,also,need,to,account,for,the,rotation.,They,become,n,=,ninf,,,nu,=,α,ninf,uinf,cos(π/4),,nv,=,α,ninf,uinf,sin(π/4),,E,=,pinf,γ,−,1,+,ninf,u2,inf,2,,,(17),(18),(19),(20),where,u,and,v,are,speeds,in,the,x,and,y,directions,respectively.,We,apply,outﬂow,conditions,by,1,at,one,end,of,the,domain,,and,1,at,the,other.,We,set,ninf,=,pinf,=,uinf,=,1,,noting,setting,α,=,that,the,density,and,velocity,have,already,been,non-dimensionalised,with,factors,of,B0/N0,and,the,sound,speed,,cs,,respectively.,On,the,(long),sides,of,the,ﬂux,tube,,boundary,conditions,are,set,to,be,periodic,for,all,ﬂuid,ﬁelds.,−,2.2.5,Fluid-only,validation,In,the,following,,we,ﬁrst,consider,validation,of,the,SIMPLE-SOL,solver,in,isolation,,that,is,,without,coupling,to,the,particle,framework.,We,choose,a,rectangular,mesh,which,is,110,units,long,,1,unit,high,and,rotated,about,the,origin,by,an,angle,θ,=,π/4.,Fluid,elements,are,quadrilateral,,with,56,along,the,SOL,axis,and,3,in,the,cross-SOL,direction.,Figure,3:,Left:,The,SOL,2-D,domain,,with,a,rotation,angle,of,θ,=,π/2.,Right:,The,SOL,2-D,domain,without,any,rotation;,the,domain,width,is,exaggerated,by,a,factor,of,three,,in,this,panel.,The,left,panel,of,Figure,3,shows,the,rotated,mesh,used,for,validation.,The,right,panel,shows,a,version,of,the,same,mesh,prior,to,rotation,,with,the,aspect,ratio,reduced,to,make,individual,quadrilateral,elements,easier,to,see.,We,set,initial,conditions,(in,non-dimensionalised,units),according,to,Table,1,and,choose,initial,conditions,to,differ,signiﬁcantly,from,the,expected,solution.,Our,ﬂuid,source,terms,are,set,to,10,Field,label,n,nu,nv,E,Table,1:,Initial,conditions,used,for,validation.,Numeric,value,1,0,0,Parameterised,value,ninf,0,0,pinf,/(γ,1),+,1.5,ninf,u2,inf,2,−,match,one,of,the,conﬁgurations,used,to,validate,the,SOLDRAKE,solver,[10].,When,plotted,parallel,to,the,SOL,axis,,the,sources,closely,resemble,those,shown,in,Figure,8,of,that,reference,,but,with,Gaussian,widths,ﬁve,times,narrower.,We,set,the,magnitude,of,each,source,to,be,constant,in,the,cross-SOL,direction.,When,the,simulation,starts,,the,ﬁelds,initially,vary,rapidly,,before,settling,down,into,a,steady,state.,This,is,seen,clearly,in,the,number,density,proﬁles,shown,in,Figure,4,,which,are,computed,at,ﬁve,output,times,between,t,=,0,and,t,=,200.,The,label,‘s’,,here,,refers,to,the,distance,along,the,SOL,axis,from,one,end,of,the,ﬁeld,line,to,the,other.,Although,we,evaluate,the,number,density,along,the,lower,edge,of,the,domain,the,symmetry,of,the,source,terms,means,that,the,same,proﬁle,can,be,obtained,along,any,line,parallel,to,the,SOL,axis.,Figure,4:,Evolution,of,the,number,density,proﬁle,along,the,SOL,axis,,from,initial,conditions,to,steady,state.,In,Figure,5,we,plot,a,comparison,between,the,steady,state,reached,by,the,SIMPLE-SOL,solver,and,an,analytic,solution,presented,by,Arter,[11].,The,top,row,of,panels,are,1-D,proﬁles,in,num-,ber,density,,velocity,and,energy,along,the,SOL,axis,,while,the,bottom,row,shows,the,difference,between,the,SIMPLE-SOL,and,analytic,solutions.,11,Figure,5:,Upper,panels:,Comparison,of,the,density,(left),,velocity,(centre),and,temperature,(right),proﬁles,along,the,SIMPLE-SOL,ﬁeld,line.,Lower,panels:,Difference,between,the,simulated,and,analytic,proﬁle.,2.2.6,Coupling,with,NESO-PARTICLES,We,make,modiﬁcations,to,the,SIMPLE-SOL,solver,to,facilitate,coupling,with,the,NESO-PARTICLESframework,as,follows:,1.,The,temperature,is,computed,based,on,the,equation,of,state,and,stored,in,a,separate,Nek-,tar,ﬁeld,at,the,beginning,of,each,time,step,,then,evaluated,at,the,particle,positions,before,calculating,the,ionisation,rates.,2.,Four,new,ﬁelds,were,added,,one,for,each,particle,source,term.,These,ﬁelds,are,explicitly,excluded,from,the,advection,operation.,3.,The,source,terms,class,was,updated,to,add,the,particle,source,ﬁelds,to,the,RHS,of,their,respective,ﬂuid,equations.,2.2.7,Particle,Creation,Along,Lines,The,model,system,includes,two,locations,where,a,neutral,species,is,introduced,into,the,domain.,We,inject,particles,at,both,ends,of,the,domain,which,represents,the,situation,where,neutral,species,are,deliberately,injected,into,the,plasma,or,where,charged,species,are,neutralised,on,contact,with,a,wall,and,are,repelled,back,into,the,plasma.,12,For,parallel,plasma,ﬂow,in,the,x,direction,,we,initialise,neutral,particles,along,straight,lines,in,the,a,and,a,for,a,constant,offset,a,and,domain,length,y,direction.,At,each,end,of,the,domain,,at,L,L,,we,deﬁne,a,collection,of,lines,centred,around,these,two,predetermined,points.,Each,collection,of,lines,spans,the,entire,domain,in,the,y,direction,and,Gaussian,spacing,in,the,x,direction.,Each,line,is,discretised,into,a,large,number,of,uniformly,spaced,points,where,particles,may,be,created.,−,Discretising,each,line,into,a,large,number,of,points,allows,performance,optimisations,to,be,made,that,reduce,the,cost,of,adding,particles,to,the,domain.,We,pre-compute,the,MPI,ranks,that,own,points,on,the,line,to,reduce,the,communication,overhead,of,adding,particles.,Secondly,we,pre-,compute,the,owning,cell,and,NEKTAR++,reference,positions,of,the,points,to,avoid,a,costly,cell,binning,process,which,would,only,occur,on,a,subset,of,MPI,ranks.,At,each,time,step,,when,we,inject,particles,,we,initialise,each,particle,with,a,computational,weight,that,represents,the,physical,number,of,particles,that,computational,particle,represents.,This,com-,putational,weight,is,subsequently,reduced,by,the,ionisation,process,we,describe,in,this,report.,Secondly,the,velocity,of,each,particle,is,sampled,from,a,Gaussian,distribution,such,that,the,over-,all,ensemble,of,neutral,particles,exhibits,a,desired,temperature.,2.2.8,Particle,Boundary,Conditions,The,2-D,system,we,describe,in,this,report,is,constructed,with,two,types,of,behaviour,for,particles,at,the,domain,edges.,In,the,y,direction,,which,is,the,perpendicular,direction,to,the,ﬁeld,lines,,we,periodically,map,particles,over,the,boundary.,In,the,x,direction,,which,is,the,direction,parallel,to,the,ﬁeld,lines,,we,remove,particles,from,the,simulation,domain,when,they,reach,the,domain,edge.,Previous,iterations,of,NESO-PARTICLES(NP),did,not,provide,users,with,a,high,level,interface,to,remove,particles.,For,the,simulation,we,describe,here,,and,to,extend,the,functionality,of,NP,,we,implemented,a,high,level,user,facing,interface,that,allows,speciﬁcation,of,which,particles,should,be,removed,from,the,simulation.,To,use,this,interface,a,user,tags,particles,that,should,be,removed,from,the,system,with,a,user,deﬁned,value,in,a,user,deﬁned,particle,property.,The,user,then,calls,the,remove,method,and,passes,their,chosen,tag,value,and,chosen,particle,property.,On,completion,of,the,call,to,the,remove,method,all,particles,matching,the,tag,value,in,the,property,are,removed.,2.3,Coupled,proxyapp,results,In,Figure,6,plot,the,distribution,of,ﬂuid,plasma,(upper,image),and,neutral,particles,(lower,image),towards,one,end,of,the,domain,,corresponding,to,the,region,closest,to,the,divertor.,The,position,of,the,particle,source,in,the,lower,panel,is,easily,identiﬁed,by,the,concentration,of,points,with,high,computational,weights,(redder,colours).,As,the,simulation,evolves,,computational,particles,move,away,from,the,source,location,,becoming,progressively,more,ionised,(bluer,colours),and,depositing,material,onto,the,plasma,density,ﬁeld,(redder,colours,in,the,upper,panel).,This,is,then,advected,towards,the,domain,boundaries,by,the,ﬂuid,solver.,Particles,crossing,the,left-boundary,13,are,automatically,removed,from,the,simulation,at,each,time,step,,using,the,mechanism,described,in,Section,2.2.8.,Figure,6:,Zoom-in,on,one,end,of,the,2-D,domain,showing,the,plasma,number,density,(top),and,distribution,of,neutral,particles,(bottom),coloured,by,weight.,To,initially,test,the,mass,conservation,properties,of,the,simulation,we,created,a,closed,system,by,replacing,the,outﬂow,boundary,conditions,in,the,x,direction,with,periodic,boundary,conditions.,This,new,system,,with,fully,periodic,boundary,conditions,,contains,zero,sinks,for,neutral,particles,or,plasma,ﬂuid,and,hence,will,rapidly,“ﬁll”,with,plasma.,As,the,system,is,closed,,accurately,measuring,the,total,mass,in,the,system,is,now,straightforward.,We,constructed,a,system,where,the,plasma,ﬁelds,n,and,(cid:126)u,are,initialised,to,1,and,(cid:126)0,respectively.,Furthermore,we,disabled,all,source,terms,except,the,mass,coupling,between,the,plasma,ﬂuid,and,neutral,particles.,This,remaining,term,is,responsible,for,ionising,neutral,particle,species,as,a,plasma,ﬂuid,density,source.,Mass,is,created,at,each,time,step,at,the,injection,points,we,describe,earlier,in,this,report.,Hence,the,total,mass,in,the,system,linearly,increases,with,time,at,a,chosen,rate.,In,Figure,7,we,plot,the,mass,stored,as,both,neutral,particles,and,plasma,ﬂuid,along,with,the,relative,error,in,total,system,mass.,As,the,system,is,closed,except,for,our,neutral,particle,injection,we,computed,the,correct,total,system,mass,as,the,mass,of,the,injected,particles,plus,the,initial,plasma,ﬁeld,density.,By,comparing,the,expected,system,mass,against,the,particle,mass,and,ﬂuid,mass,we,quantiﬁed,any,loss,in,mass,due,to,conversion,between,particle,and,ﬂuid,representations,or,loss,of,mass,due,to,implementation,errors.,We,observe,good,conservation,of,mass,from,this,14,test,case.,Figure,7:,Mass,conservation,test,for,closed,system,under,periodic,boundary,conditions.,Mass,expressed,in,terms,of,particle,number.,Black:,relative,error,in,total,system,mass.,Blue:,mass,contained,in,ﬂuid,density,ﬁelds.,Red:,mass,stored,on,neutral,particles.,15,0.00.20.40.6Time0123456Mass×1020ParticleMassFluidMass246810RelativeError×10−15,3,Executive,Summaries,This,section,both,introduces,the,context,and,summarises,two,reports,in,the,higher,dimensional,work,package.,The,ﬁrst,relates,to,implementing,higher,dimensional,models,using,a,continuum,and,the,second,is,an,investigation,into,the,performance,of,code,related,to,the,ﬁrst.,Accepted,reports,are,held,on,the,Documents,repository,of,the,ExCALIBUR-NEPTUNE,organisa-,tion,on,GitHub,,to,which,belong,other,repos,containing,software,developed,under,project,NEP-,TUNE.,Note,that,some,of,these,repos,may,be,access-controlled,,please,email,neptune@ukaea.uk,if,difﬁculties,are,encountered,in,seeing,the,material.,3.1,Implementation,of,TensorRegions,library,in,Nektar++,Authors:,Chris,Cantwell,,Spencer,Sherwin,,and,David,Moxey.,The,context,of,this,brief,report[12],is,the,step,change,in,exhaust,power,of,a,power-plant,scale,tokamak,compared,to,that,of,current,experimental,devices.,The,resulting,increase,in,local,plasma,temperature,will,reduce,the,collisionality,of,the,plasma,in,the,scrape-off-layer,thereby,rendering,the,existing,set,of,ﬂuid,models,and,ﬂuid,numerical,methods,much,less,accurate,in,this,parame-,ter,regime.,Although,NEPTUNE,includes,a,particle,modelling,workstream,,which,also,enables,kinetic,effects,,particle,simulations,have,limitations,due,to,sampling,noise,which,deterministic,ﬁ-,nite,element,calculations,do,not,suffer,from.,Higher,dimensional,ﬁnite,element,calculations,have,their,own,issues,however,,notably,regarding,cost,,and,to,some,extent,the,two,approaches,are,complementary.,The,extension,of,NEKTAR++,to,accommodate,one-,or,two-dimensional,velocity,space,continuum,grids,(typically,referred,to,by,1V,or,2V),superimposed,onto,1-D,,2-D,and,3-D,spatial,domains,is,de-,tailed,in,this,report.,The,introduction,describes,how,existing,components,have,been,re-used,in,the,development,of,this,feature.,The,second,section,on,implementation,explains,the,how,to,conﬁgure,and,create,the,additional,continuum,dimensions,to,resolve,velocity,space:,the,TensorRegion(ie.,the,velocity,space,representation,embedded,in,a,spatial,region);,the,TensorStorage,or,storage,arrays,for,calculations;,and,a,read/write,View,of,this,underlying,data.,Next,code,snippets,are,given,in,the,Example,Usage,section,,where,it,is,explained,how,this,work,ﬁts,into,the,wider,context,of,NEKTAR++,developments.,The,report,closes,with,automatically,generated,API,documentation.,3.1.1,Report,on,DG,Performance,in,NEKTAR++,Authors:,Edward,Laughton,,David,Moxey,,Chris,Cantwell,,and,Spencer,Sherwin.,This,report[13],concerns,high,order,discontinuous,Galerkin,(DG),methods,,which,have,many,attractive,properties,for,Exascale,ﬂuid,dynamics.,Arguably,ﬁrst,among,these,is,the,accuracy,achieved,per,unit,amount,of,MPI,communication.,Since,Nektar++,makes,use,of,spatial,DG,meth-,ods,for,higher,dimensional,methods,,which,comes,at,a,higher,computational,cost,due,to,the,curse,of,dimensionality,,it,is,imperative,that,the,implementation,is,as,performant,as,possible.,This,re-,port,details,a,real,world,simulation,case,,a,Taylor-Green,vortex,,to,attempt,to,identify,bottlenecks,16,for,this,high,dimensional,relevant,method.,Ultimately,,no,out-of-the-ordinary,bottlenecks,exist,for,the,current,implementation,on,x86-64,architectures.,However,,having,performed,some,tests,and,analysed,the,proﬁling,date,,the,authors,highlight,a,few,areas,where,algorithm,improvements,may,be,made.,The,ﬁrst,section,summarises,the,DG,formulation,for,the,Navier-Stokes,(NS),system,of,equations,,giving,emphasis,to,components,of,it,that,will,feature,later,in,the,report:,the,number,of,commu-,nicated,degrees,of,freedom;,the,requirement,for,an,inverse,matrix,multiplication;,the,auxillary,variable,required,to,accommodate,the,diffusion,operator,separating,NS,from,compressible,Euler.,The,experimental,setup,of,6th,order,3-D,advection-diffusion,system,(Navier-Stokes),on,an,8,8,grid,is,introduced.,×,×,8,The,second,section,describes,the,proﬁling,procedure,as,well,as,some,caveats,around,different,approaches,to,MPI,communication,that,may,inﬂuence,results.,As,such,it,is,noted,that,care,was,taken,when,proﬁling,MPI,communication.,The,results,section,comes,third.,It,notes,the,requirement,of,an,MPI,AllReduce,in,each,substep,of,the,Runge-Kutta,4,integrator,,that,the,ﬂux,values,must,be,communicated,across,sub-domain,boundaries,,and,that,there,is,some,jitter,in,the,MPI,but,would,not,adversely,affect,wall-clock,time,for,the,whole,simulation.,It,is,noted,that,the,ﬂuid,solver,spends,much,of,its,time,in,low,level,matrix-multiply,BLAS,calls,,as,expected.,The,report,concludes,with,several,observations,that,might,help,improve,performance:,that,the,cost,of,the,inverse,matrix,multiply,may,be,alleviated,by,a,real,Schur,decomposition,of,the,matrix,or,by,swapping,to,the,use,of,orthogonal,polynomials.,an,MPI,call,could,be,streamlined,so,as,not,to,send,extraneous,data,for,this,use-case.,an,area,of,the,code,has,been,found,where,it,is,possible,to,interleave,MPI,with,compute.,•,•,•,4,Summary,In,this,report,we,describe,a,spatially,2-D,model,for,ﬂuid,plasma,equations,relevant,to,the,plasma,exhaust.,This,model,consists,of,a,ﬂuid,system,to,describe,a,plasma,species,and,a,particle,system,to,describe,a,neutral,species.,These,two,species,are,coupled,through,an,interaction,between,plasma,and,neutrals,where,neutral,species,are,ionised,at,a,particular,rate.,The,ionised,particles,create,a,source,term,for,plasma,species,in,the,associated,ﬂuid,equations.,Hence,there,exists,a,coupling,from,neutral,species,to,plasma,species.,Secondly,the,ionisation,rate,,evaluated,at,particle,locations,,is,a,function,of,the,plasma,density,and,temperature.,Hence,there,exists,a,coupling,from,plasma,species,to,neutral,species.,The,implementation,of,the,coupling,operations,relies,on,the,capability,to,evaluate,ﬁnite,element,functions,at,particle,locations,and,the,ability,to,convert,particle,representations,to,ﬁnite,element,representations.,These,evaluation,and,projection,operations,are,frequently,performed,and,ex-,pensive,operations,and,hence,are,performance,critical.,As,part,of,the,task,work,for,this,report,we,implemented,algorithms,to,perform,these,operations,within,SYCL.,SYCL,implementations,of,17,these,core,operations,improve,the,overall,performance,portability,of,the,NESO,framework,and,allow,these,operations,to,be,executed,on,a,wider,range,of,hardware.,We,complete,the,description,of,our,own,work,in,this,report,by,presenting,initial,validation,results,from,the,ﬂuid,and,particle,sys-,tems.,These,validation,results,are,important,to,demonstrate,that,the,coupling,between,ﬂuid,and,particles,is,correctly,implemented,and,conserves,key,system,quantities.,Lastly,,summaries,and,links,to,external,grant,work,associated,with,D4c,are,provided.,Acknowledgement,The,support,of,the,UK,Meteorological,Ofﬁce,and,Strategic,Priorities,Fund,is,acknowledged.,References,[1],W,Lotz.,Electron-impact,ionization,cross,sections,and,ionization,rate,coefﬁcients,for,atoms,and,ions,from,hydrogen,to,calcium.,Z.,Phys.,,216:,241-7(1968).,,1,1968.,[2],E.L.,Freeman,and,E.M.,Jones.,Experiments.,scientific-publications.ukaea.uk/wp-content/uploads/CLM-R137.pdf.,Technical,Report,CLM-R137,,Culham,Laboratory,,1974.,Atomic,Collision,Processes,in,Plasma,Physics,https://,[3],D.A.,Barry,,J.-Y.,Parlange,,and,L.,Li.,Approximation,for,the,exponential,integral,(Theis,well,function).,Journal,of,Hydrology,,227(1-4):287–291,,2000.,[4],Jean-Paul,Berrut,and,Lloyd,N.,Trefethen.,Barycentric,lagrange,interpolation.,SIAM,Review,,46(3):501–517,,2004.,[5],W.,Arter,,J.,Cook,,and,W.,Saunders.,1-D,and,2-D,particle,models.,nical,Report,CD/EXCALIBUR-FMS/0070-M4c.1,,github.com/ExCALIBUR-NEPTUNE/Documents/blob/main/reports/ukaea_reports/,CD-EXCALIBUR-FMS0070-M4c.1.pdf.,UKAEA,,2022.,Tech-,https://,[6],D.,Moxey,et,al.,1D,SOL,Solver.,https://github.com/ExCALIBUR-NEPTUNE/nektar-1d-sol,,2022.,[7],W.,Arter,et,al.,Equations,for,EXCALIBUR/NEPTUNE,Proxyapps.,cal,Report,CD/EXCALIBUR-FMS/0021-1.24-M1.2.1,,UKAEA,,1,2023.,//github.com/ExCALIBUR-NEPTUNE/Documents/blob/main/reports/ukaea_reports/,CD-EXCALIBUR-FMS0021-1.24-M1.2.1.pdf.,Techni-,https:,[8],Eleuterio,F.,Toro.,Riemann,Solvers,and,Numerical,Methods,for,Fluid,Dynamics.,Springer,Berlin,Heidelberg,,2009.,[9],G.,Karniadakis,and,S.,Sherwin.,Spectral/hp,element,methods,for,computational,ﬂuid,dy-,namics,2nd,Ed.,Oxford,University,Press,,2005.,https://doi.org/10.1093/acprof:oso/,9780198528692.001.0001.,18,[10],W.,Saunders,and,E.,Threlfall.,nical,Report,CD/EXCALIBUR-FMS/0047-M2.2.2,,//github.com/ExCALIBUR-NEPTUNE/Documents/blob/main/reports/ukaea_reports/,CD-EXCALIBUR-FMS0047-M2.2.2.pdf.,Finite,Element,Models:,UKAEA,,Performance.,2021.,9,Tech-,https:,[11],Wayne,Arter.,Study,of,source,terms,in,the,SOLF1D,edge,code.,Technical,report,,Eurofu-,sion/CCFE,,2015.,CCFE-DETACHMENT-RP2-Draft.,[12],C.,Cantwell,,S.J.,Sherwin,,and,D.,Moxey.,D1.1:,Implementation,of,TensorRegions,library,in,Nektar++.,Technical,Report,2060042-TN-01-2,,UKAEA,Project,Neptune,,2022.,https://,github.com/ExCALIBUR-NEPTUNE/Documents/blob/main/reports/2060042/TN-01-2.pdf.,[13],D.,Moxey,,C.,Cantwell,,and,S.J.,Sherwin.,D3.1:,Report,on,DG,performance,in,Nektar++.,Technical,Report,2060042-TN-02-4,,UKAEA,Project,Neptune,,2022.,https://github.com/,ExCALIBUR-NEPTUNE/Documents/blob/main/reports/2060042/TN-02-4.pdf.,19

:pdfembed:`src:_static/CD-EXCALIBUR-FMS0072-M4c.2_ExcaliburFusionModellingSystem.pdf, height:1600, width:1100, align:middle`

